name: Build

on: 
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branch: 
      - "[0-9].[0-9](\\-rel)?"
  push:
    branch: 
      - "[0-9].[0-9](\\-rel)?"

permissions:
  contents: write # Fetch code (actions/checkout), create release
  packages: write # Upload and publish packages to GitHub Packages

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
            deps_name: x64-windows
            vcpkg_path: C:\mixxx-vcpkg
            vcpkg_bootstrap: .\bootstrap-vcpkg.bat
            vcpkg_triplet: x64-windows
            vcpkg_host_triplet: x64-windows
            check_disk_space: Get-PSDrive
          - os: windows-11-arm
            deps_name: arm64-windows
            vcpkg_path: C:\mixxx-vcpkg
            vcpkg_bootstrap: .\bootstrap-vcpkg.bat
            vcpkg_triplet: arm64-windows
            vcpkg_host_triplet: arm64-windows
            check_disk_space: Get-PSDrive
          - os: macos-13
            deps_name: x64-osx
            vcpkg_path: /Users/runner/mixxx-vcpkg
            vcpkg_bootstrap: ./bootstrap-vcpkg.sh
            vcpkg_triplet: x64-osx-min1100
            vcpkg_host_triplet: x64-osx-min1100
            developer_dir: /Applications/Xcode_14.2.app/Contents/Developer
            check_disk_space: df -h
          - os: macos-13
            deps_name: arm64-osx-cross
            vcpkg_path: /Users/runner/mixxx-vcpkg
            vcpkg_bootstrap: ./bootstrap-vcpkg.sh
            vcpkg_triplet: arm64-osx-min1100
            vcpkg_host_triplet: x64-osx-min1100-release
            developer_dir: /Applications/Xcode_14.2.app/Contents/Developer
            check_disk_space: df -h
          - os: macos-14
            deps_name: arm64-osx
            vcpkg_path: /Users/runner/mixxx-vcpkg
            vcpkg_bootstrap: ./bootstrap-vcpkg.sh
            vcpkg_triplet: arm64-osx-min1100
            vcpkg_host_triplet: arm64-osx-min1100
            developer_dir: /Applications/Xcode_15.4.app/Contents/Developer
            brew_extra: libtool
            check_disk_space: df -h
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.vcpkg_triplet }}
      VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.vcpkg_host_triplet }}
      DEPS_BASE_NAME: mixxx-deps
      DEVELOPER_DIR: ${{ matrix.developer_dir }}
      MIXXX_VERSION: 2.6
    name: ${{ matrix.deps_name }}
    runs-on: ${{ matrix.os }}
    steps:
    - name: Check out git repository
      uses: actions/checkout@v4
      with:
        path: mixxx-vcpkg
      
      # Workaround for issues https://github.com/microsoft/vcpkg/issues/8272  
      # and https://github.com/actions/checkout/issues/197 
      # to keep the build path short and work around size limits on the windows runner D: drive 
    - name: Move checkout
      run: cmake -E copy_directory ${{ github.workspace }}/mixxx-vcpkg ${{ matrix.vcpkg_path }}
       
    - name: "Authenticate to GitHub Packages (readwrite)"
      if: runner.os != 'Linux' && github.event_name == 'push' && github.repository_owner == 'mixxxdj'
      shell: bash
      run: |
        nuget sources add -Name "mixxx-github-packages" -Source "https://nuget.pkg.github.com/mixxxdj/index.json" -UserName "${{ github.repository_owner }}" -Password "${{ secrets.GITHUB_TOKEN }}" -StorePasswordInClearText
        nuget setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "mixxx-github-packages"
        echo "VCPKG_BINARY_SOURCES=clear;nuget,mixxx-github-packages,readwrite;" >> "${GITHUB_ENV}"
        
    - name: "Authenticate to GitHub Packages (read only)"
      if: runner.os != 'Linux' && (github.event_name == 'pull_request' || github.repository_owner != 'mixxxdj') 
      shell: bash
      run: |
        nuget sources add -Name "mixxx-github-packages" -Source "https://nuget.pkg.github.com/mixxxdj/index.json" -UserName "${{ github.repository_owner }}" -Password "${{ secrets.GITHUB_TOKEN }}" -StorePasswordInClearText
        nuget setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "mixxx-github-packages"
        echo "VCPKG_BINARY_SOURCES=clear;nuget,mixxx-github-packages,read;" >> "${GITHUB_ENV}"   

    - name: Read sha_short
      id: vars
      shell: bash
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      working-directory: ${{ matrix.vcpkg_path }}

    - name: Bootstrap vcpkg
      run: ${{ matrix.vcpkg_bootstrap }}
      working-directory: ${{ matrix.vcpkg_path }}

    - name: "[macOS] Bootstrap vcpkg"
      if: runner.os == 'macOS'
      run: |
          brew update && brew install nasm automake autoconf-archive coreutils ${{ matrix.brew_extra }}
          sudo xcode-select --switch "$DEVELOPER_DIR"
          xcrun --show-sdk-version

    - name: Check available disk space
      run: ${{ matrix.check_disk_space }}

    - name: Build packages  
      run: ./vcpkg install --vcpkg-root=${{ matrix.vcpkg_path }} --clean-after-build --recurse --feature-flags="-compilertracking,manifests,registries,versions" --x-abi-tools-use-exact-versions
      working-directory: ${{ matrix.vcpkg_path }}

    - name: "[Windows] Install TrustedSigning"
      env:
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      if: runner.os == 'Windows' && env.AZURE_TENANT_ID
      shell: 'pwsh'   
      run: |
        Install-Module -Name TrustedSigning -Scope CurrentUser -Force -Repository PSGallery
        Import-Module TrustedSigning
        
    - name: "[Windows] Sign release DLLs"
      env:
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      if: runner.os == 'Windows' && env.AZURE_TENANT_ID
      uses: azure/trusted-signing-action@v0.5.1
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: https://weu.codesigning.azure.net/
        trusted-signing-account-name: mixxx
        certificate-profile-name: mixxx
        files-folder: ${{ matrix.vcpkg_path }}/vcpkg_installed/${{ matrix.vcpkg_triplet }}/bin
        files-folder-filter: dll
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        timeout: 600
        
    - name: "[Windows] Sign release plugins"
      env:
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      if: runner.os == 'Windows' && env.AZURE_TENANT_ID
      uses: azure/trusted-signing-action@v0.5.1
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: https://weu.codesigning.azure.net/
        trusted-signing-account-name: mixxx
        certificate-profile-name: mixxx
        files-folder: ${{ matrix.vcpkg_path }}/vcpkg_installed/${{ matrix.vcpkg_triplet }}/Qt6/plugins
        files-folder-filter: dll
        files-folder-recurse: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        timeout: 600
        
    - name: "[Windows] Sign qml DLLs"
      env:
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      if: runner.os == 'Windows' && env.AZURE_TENANT_ID
      uses: azure/trusted-signing-action@v0.5.1
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: https://weu.codesigning.azure.net/
        trusted-signing-account-name: mixxx
        certificate-profile-name: mixxx
        files-folder: ${{ matrix.vcpkg_path }}/vcpkg_installed/${{ matrix.vcpkg_triplet }}/Qt6/qml
        files-folder-filter: dll
        files-folder-recurse: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        timeout: 600

    - name: Upload GitHub Actions artifacts of build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ matrix.deps_name }}
        path: ${{ matrix.vcpkg_path  }}/buildtrees/**/*.log

    - name: Create buildenv archive
      run: ./vcpkg export --vcpkg-root=${{ matrix.vcpkg_path }} --x-all-installed --zip --output=${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.deps_name }}-${{ steps.vars.outputs.sha_short }} --output-dir=${{ matrix.vcpkg_path }}
      working-directory: ${{ matrix.vcpkg_path }}
      
    - name: "[Windows x64] Install additional tools"
      if: matrix.os == 'windows-2022' && env.SSH_PASSWORD != null
      env:
        SSH_PASSWORD: ${{ secrets.DOWNLOADS_HOSTGATOR_DOT_MIXXX_DOT_ORG_KEY_PASSWORD }}
      run: |
        $Env:PATH="C:\msys64\usr\bin;$Env:PATH"
        pacman -S --noconfirm coreutils bash rsync openssh
        Add-Content -Path "$Env:GITHUB_ENV" -Value "PATH=$Env:PATH"
        
    - name: "[Windows ARM64] Install additional tools"
      if: matrix.os == 'windows-11-arm' && env.SSH_PASSWORD != null
      env:
        SSH_PASSWORD: ${{ secrets.DOWNLOADS_HOSTGATOR_DOT_MIXXX_DOT_ORG_KEY_PASSWORD }}
      run: |
        choco install msys2 -y
        $Env:PATH="C:\tools\msys64\usr\bin;$Env:PATH"
        pacman -S --noconfirm coreutils bash rsync openssh
        Add-Content -Path "$Env:GITHUB_ENV" -Value "PATH=$Env:PATH"

    - name: "Upload build to downloads.mixxx.org"
      if: github.event_name == 'push' && env.SSH_PASSWORD != null
      # Use retry loop to work around intermittent transfer issue
      uses: nick-fields/retry@9417ab499314dfe692edb043ded2ff9b3f5f0a68 # v3
      with:
        max_attempts: 10
        timeout_minutes: 20
        retry_wait_seconds: 5
        command: |
          cd ${{ matrix.vcpkg_path }}
          bash .github/deploy.sh ${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.deps_name }}-${{ steps.vars.outputs.sha_short }}.zip
        on_retry_command: |
          killall ssh-agent || true
      env:
        DESTDIR: public_html/downloads/dependencies
        OS: ${{ runner.os }}
        SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        SSH_HOST: downloads-hostgator.mixxx.org
        SSH_KEY: ${{ secrets.DOWNLOADS_HOSTGATOR_DOT_MIXXX_DOT_ORG_KEY }}
        SSH_PASSWORD: ${{ secrets.DOWNLOADS_HOSTGATOR_DOT_MIXXX_DOT_ORG_KEY_PASSWORD }}
        SSH_USER: mixxx
        UPLOAD_ID: ${{ github.run_id }}

    - run: |
        if ! gh release view --repo "${{ github.repository }}" "${RELEASE_NAME}" &> /dev/null
        then 
          gh release create --repo "${{ github.repository }}" "${RELEASE_NAME}" \
            --generate-notes \
            --latest \
            --target "${{ github.push.after }}" ${{ !endsWith( github.event.ref, '-rel' ) && '--prerelease' || '' }}
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_NAME: ${{ env.MIXXX_VERSION }}-${{ steps.vars.outputs.sha_short }}
      if: ${{ github.event_name == 'push' }}
      id: ghrelease
      shell: bash
      name: "Creates a release in GitHub if it doesn't exist yet"

    - run: |
        vcpkgFileName="${DEPS_BASE_NAME}-${MIXXX_VERSION}-${VCPKG_TRIPLET}-${SHA_SHORT}"
        sha256sum "${VCPKG_ASSET_PATH}" | cut -d' ' -f 1 > "${vcpkgFileName}.zip.sha256"
        split -b1536m -d "${VCPKG_ASSET_PATH}" "${vcpkgFileName}.zip.part"
        gh release upload --repo "${{ github.repository }}" "${RELEASE_NAME}" ${vcpkgFileName}.zip*
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SHA_SHORT: ${{ steps.vars.outputs.sha_short }}
        VCPKG_TRIPLET: ${{ matrix.vcpkg_triplet }}
        RELEASE_NAME: ${{ env.MIXXX_VERSION }}-${{ steps.vars.outputs.sha_short }}
        VCPKG_ASSET_PATH: ${{ matrix.vcpkg_path }}/${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.vcpkg_triplet }}-${{ steps.vars.outputs.sha_short }}.zip
      shell: bash
      if: runner.os != 'Windows' && steps.ghrelease.outcome == 'success'
      name: "[MacOS] Creates assets and upload to GitHub release"

    - run: |
        $stream = [System.IO.File]::OpenRead("${{ matrix.vcpkg_path }}/${{ env.VCPKG_ASSET_PATH }}")
        $chunkNum = 0
        $bufSize = 1536MB
        $barr = New-Object byte[] $bufSize

        while( $bytesRead = $stream.Read($barr,0,$bufSize)){
          $outFile = "${{ env.VCPKG_ASSET_PATH }}.part$chunkNum"
          $ostream = [System.IO.File]::OpenWrite($outFile)
          $ostream.Write($barr,0,$bytesRead);
          $ostream.close();
          echo "wrote $outFile"
          $chunkNum += 1
        }
        (Get-FileHash -Algorithm SHA256 -Path "${{ matrix.vcpkg_path }}/${{ env.VCPKG_ASSET_PATH }}").Hash | Out-File -FilePath "${{ env.VCPKG_ASSET_PATH }}.sha256"
        gh release upload --repo "${{ github.repository }}" "${{ env.RELEASE_NAME }}" (get-item .\${{ env.VCPKG_ASSET_PATH }}.*).FullName
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_NAME: ${{ env.MIXXX_VERSION }}-${{ steps.vars.outputs.sha_short }}
        VCPKG_ASSET_PATH: ${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.vcpkg_triplet }}-${{ steps.vars.outputs.sha_short }}.zip
      if: runner.os == 'Windows' && steps.ghrelease.outcome == 'success'
      name: "[Windows] Creates assets and upload to GitHub release"

    - name: Upload GitHub Actions artifacts
      if: ${{ steps.ghrelease.outcome == 'skipped' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.deps_name }}-${{ steps.vars.outputs.sha_short }}
        path: ${{ matrix.vcpkg_path }}/${{ env.DEPS_BASE_NAME }}-${{ env.MIXXX_VERSION }}-${{ matrix.deps_name }}-${{ steps.vars.outputs.sha_short }}.zip

    # Workaround for https://github.com/actions/cache/issues/531
    - name: Use system tar & zstd from Chocolatey for caching
      shell: bash
      run: |
        echo "C:/Windows/System32;C:/ProgramData/Chocolatey/bin" >> $GITHUB_PATH
